/*! comment-editor 0.1.0 2015-04-13 */
!function(){String.prototype.jaso=function(){return a(this)};var a=function(a){for(var b=new Array(12593,12594,12596,12599,12600,12601,12609,12610,12611,12613,12614,12615,12616,12617,12618,12619,12620,12621,12622),c=new Array(12623,12624,12625,12626,12627,12628,12629,12630,12631,12632,12633,12634,12635,12636,12637,12638,12639,12640,12641,12642,12643),d=new Array(0,12593,12594,12595,12596,12597,12598,12599,12601,12602,12603,12604,12605,12606,12607,12608,12609,12610,12612,12613,12614,12615,12616,12618,12619,12620,12621,12622),e=new Array,f=new Array,g=0;g<a.length;g++)if(e[g]=a.charCodeAt(g),e[g]>=44032&&e[g]<=55203){var h,i,j;j=e[g]-44032,h=j/588,j%=588,i=j/28,j%=28,f.push(String.fromCharCode(b[parseInt(h)])),f.push(String.fromCharCode(c[parseInt(i)])),0!=j&&f.push(String.fromCharCode(d[parseInt(j)]))}else f.push(String.fromCharCode(e[g]));return f.join("")}}(),function(a){var b={BACKSPACE:8,DELETE:46,TAB:9,RETURN:13,ESC:27,COMMA:188,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40},c={findMentionTrigger:function(){var a,b,c,d,e=document,f=e.defaultView||e.parentWindow,g="";if("undefined"!=typeof f.getSelection){for(a=f.getSelection(),b=a.getRangeAt(0),c=b.cloneRange(),d=b.endContainer,c.selectNodeContents(b.endContainer);null!=d.previousSibling&&3==d.previousSibling.nodeType;)d=d.previousSibling;c.setStart(d,0);var h=d.data.search(/\s/);(0>h||h<b.endOffset)&&(h=d.data.length),h>b.endOffset?c.setEnd(d,h):c.setEnd(b.endContainer,b.endOffset),g=c.toString()}else if((a=e.selection)&&"Control"!=a.type){var i=a.createRange(),j=e.body.createTextRange();j.moveToElementText(element),j.setEndPoint("EndToEnd",i),g=j.text}var k=g.lastIndexOf("@");return 0>k?{index:k}:{index:k,data:g.slice(k+1,g.length)}},selectMention:function(){var a,b,c,d,e=document,f=e.defaultView||e.parentWindow;if("undefined"!=typeof f.getSelection){for(a=f.getSelection(),b=a.getRangeAt(0),c=b.cloneRange(),d=b.endContainer,c.selectNodeContents(b.endContainer);null!=d.previousSibling&&3==d.previousSibling.nodeType&&d.data.search(/@/)<0;)d=d.previousSibling;c.setStart(d,d.data.lastIndexOf("@",b.endOffset));var g=b.endContainer.data.search(/\s/);(0>g||g<b.endOffset)&&(g=b.endContainer.data.length),g>b.endOffset?c.setEnd(b.endContainer,g):c.setEnd(b.endContainer,b.endOffset),a.addRange(c)}else if((a=e.selection)&&"Control"!=a.type){var h=a.createRange(),i=e.body.createTextRange();i.moveToElementText(element),i.setEndPoint("EndToEnd",h),i.select()}},getCaretPosition:function(a){var b,c=0,d=a.ownerDocument||a.document,e=d.defaultView||d.parentWindow;if("undefined"!=typeof e.getSelection){if(b=e.getSelection(),b.rangeCount>0){var f=e.getSelection().getRangeAt(0),g=f.cloneRange();g.selectNodeContents(a),g.setEnd(f.endContainer,f.endOffset),c=g.toString().length}}else if((b=d.selection)&&"Control"!=b.type){var h=b.createRange(),i=d.body.createTextRange();i.moveToElementText(a),i.setEndPoint("EndToEnd",h),c=i.text.length}return c},moveCaret:function(a,b){var c,d;window.getSelection?(d=document.createRange(),d.selectNodeContents(a),b&&(d.setStart(a,0),d.setEnd(a,0)),d.collapse(!1),c=window.getSelection(),c.removeAllRanges(),c.addRange(d)):document.selection&&(d=document.body.createTextRange(),d.moveToElementText(a),d.collapse(!1),d.select())},moveCaretBefore:function(b){var d=document.createTextNode(" ");a(d).insertBefore(b),c.moveCaret(d,!0)},moveCaretAfter:function(b){var d=document.createTextNode(" ");a(d).insertAfter(b),c.moveCaret(d,!1)},insertNodeOverSelection:function(b,d){var e,f,g;window.getSelection?(e=window.getSelection(),e.getRangeAt&&e.rangeCount&&(f=e.getRangeAt(0),a.contains(d[0],f.commonAncestorContainer)?(f.deleteContents(),f.insertNode(b)):d.append(b))):document.selection&&document.selection.createRange&&(f=document.selection.createRange(),a.contains(d[0],f.parentElement())?(g=3==b.nodeType?b.data:b.outerHTML,f.pasteHTML(g)):d.append(b)),c.moveCaretAfter(b)},trim:function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},jaso:function(a){return a.jaso()}},d=function(b,d){var e=a("<ul class='_mention_list'></ul>"),f=[],g=[],h={},i=b||[],j={},k=d,l=0,m=function(){var a,b;for(a=0;a<i.length;a++)b=i[a],b.jaso=c.jaso(b.userName),j[b.userId]=b;e.on("mousedown",w),e.delegate("li","mouseover",x)},n=function(a,b){j[a.userId]||(a.jaso=c.jaso(a.userName),i.push(a),j[a.userId]=a),b&&!h[a.userId]&&(g.push(a),h[a.userId]=a)},o=function(b){var c=a("<li><span class='comment_profile'><img class='image' src='"+b.userImage+"'></span><span class='text'>"+b.userName+"</span></li>");return c.data("id",b.userId),c},p=function(){u(f.length>l+1?l+1:0)},q=function(){l-1>=0&&u(l-1)},r=function(){if(f.length>l){var a=f[l];k(j[a.data("id")])}v()},s=function(a,b){var d,e,f=[];if(a=a?c.trim(a):"",a&&0!=a.length){var h=c.jaso(a);for(d=0;d<i.length;d++)e=i[d],!b[e.userId]&&(e.userName.toUpperCase().indexOf(a.toUpperCase())>-1||e.jaso.indexOf(h)>-1)&&f.push(e)}else for(d=0;d<g.length;d++)e=g[d],!b[e.userId]&&(e.userName.toUpperCase().indexOf(a.toUpperCase())>-1||e.jaso.indexOf(h)>-1)&&f.push(e);f.length>0?t(f):v()},t=function(a){var b,c;for(e.empty(),f=[],b=0;b<a.length;b++)c=o(a[b]),e.append(c),f.push(c);u(0),e.show()},u=function(a){f.length>a&&(f.length>l&&f[l].removeClass("select"),l=a,f[a].addClass("select"))},v=function(){f=[],e.hide(),e.empty()},w=function(a){a.preventDefault(),r()},x=function(b){u(a(this).index())};return m(),{view:function(){return e},added:function(){return _addedList},next:function(){p()},prev:function(){q()},select:function(){r()},isVisible:function(){return a.expr.filters.visible(e[0])},hide:function(){v()},search:function(a,b){s(a,b||{})},add:function(a,b){n(a,b)}}},e=function(e,f){var g,h=a(e),i=f||{},j=a("<div contenteditable></div>"),k=a("<div class='editor_placeholder'></div>"),l=null,m=function(a){l&&l.view().remove(),l=d(a,r),l.view().insertAfter(h),l.hide()},n=function(a,b){l&&l.add(a,b)},o=function(){var a=i.mentions||[],b=i.value||h.val();g=i.maxLength||h.attr("maxlength"),j.html(w(b)),j.attr("class",h.attr("class")),j.insertBefore(h),k.html(h.attr("placeholder")),k.insertBefore(h),q(),h.hide(),m(a),j.on("paste",x),j.on("drop",y),j.on("keyup",z),j.on("keydown",A)},p=function(){j.html(""),h.val(""),q()},q=function(){j.text().length>0?k.hide():k.show()},r=function(b){b&&(c.selectMention(),c.insertNodeOverSelection(a("<span class='_mention' data-id='"+b.userId+"'>@"+b.userName+"</span>")[0],j))},s=function(b){if(b.index<0)return void l.hide();var c={};j.find("span[data-id]").each(function(){var b=a(this);c[b.data("id")]=b.text()}),l.search(b.data,c)},t=function(){return u(j)},u=function(b){var c,d,e,f,g=[],h=a(b).contents(),i=function(a){return a&&("DIV"==a.nodeName||"P"==a.nodeName)},j=function(a){return a&&"BR"==a.nodeName};if(i(b)&&1==h.length&&j(h[0]))return"";for(c=0;c<h.length;c++)d=h[c],d.nodeType!=Node.TEXT_NODE?(f=a(d).data("id"),f?g.push("@["+f+"]"):(0!=c&&i(d)&&!i(e)&&g.push("\n"),g.push(u(d)),(i(d)||j(d))&&g.push("\n"),e=d)):g.push(d.data);return g.join("")},v=function(){var b=[];return j.find("span[data-id]").each(function(){var c=a(this);b.push({id:c.data("id"),name:c.text()})}),b},w=function(a){return a.replace(/@\[([^\]]+):([^\]]+)\]/g,"<span class='_mention' data-id='$1'>@$2</span>").replace(/\\/g,"")},x=function(a){a.preventDefault();var b,c=length=g-t().length;(a.originalEvent||a).clipboardData?(b=(a.originalEvent||a).clipboardData.getData("text/plain"),b=b.substring(0,c),document.execCommand("insertText",!1,b)):window.clipboardData&&(b=window.clipboardData.getData("Text"),b=b.substring(0,c),document.selection.createRange().pasteHTML(b))},y=function(a){return a.preventDefault(),!1},z=function(a){switch(a.keyCode){case b.ESC:case b.UP:case b.DOWN:case b.TAB:case b.RETURN:return}s(c.findMentionTrigger()),q()},A=function(d){if(!d.ctrlKey&&!d.metaKey){switch(d.keyCode){case b.ESC:return void(l.isVisible()&&(l.hide(),d.preventDefault()));case b.UP:return void(l.isVisible()&&(l.prev(),d.preventDefault()));case b.DOWN:case b.TAB:return void(l.isVisible()&&(l.next(),d.preventDefault()));case b.RETURN:if(l.isVisible())return l.select(),void d.preventDefault();break;case b.LEFT:case b.RIGHT:case b.HOME:case b.END:case b.PAGEUP:case b.PAGEDOWN:case b.DELETE:case b.BACKSPACE:return}var e=t().length;if(e>g)return void d.preventDefault();if(window.getSelection){var f=window.getSelection().anchorNode;if(f=3==f.nodeType?f.parentNode:f,"SPAN"==f.tagName){switch(d.keyCode){case b.BACKSPACE:case b.DELETE:return d.preventDefault(),void a(f).remove()}var h=c.getCaretPosition(f);0==h?c.moveCaretBefore(f):c.moveCaretAfter(f)}}}};return o(),{value:function(){return t()},mentions:function(){return v()},initMentions:function(a){m(a)},addMention:function(a,b){n(a,b)},reset:function(){p()},focus:function(){j.focus()}}};a.fn.editor=function(b){return this.is("textarea")||a.error("not textarea"),this.length>0?a.data(this[0],"editor")||a.data(this[0],"editor",new e(this,b)):void 0}}(jQuery);